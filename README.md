# Intel LiDAR 断面図化プロジェクト

護岸前面の LiDAR 点群から「ある1本の垂直断面」の形状を抽出し、時間経過による変形（初期との差分）をグラフで見るためのツールです。  
学生向けに、**目的・パラメータの意味・処理の流れ・各処理の内容**をまとめています。

---

## 1. 目的（このコードで何をしているか）

### やりたいこと

- **Intel LiDAR** で取得した **3次元点群（PLYファイル）** がある。
- その中から「**護岸の前面を切る、ある1本の垂直断面**」だけを取り出す。
- その断面を **距離–高さ（Z）の1本の線（プロファイル）** にし、**時間が経つごとの変化**（最初の断面との差分）を **mm 単位** で可視化する。

### なぜこうするか

- 点群は「空間にばらばらに並んだ点」なので、そのままでは「どの断面がどう変わったか」が分かりにくい。
- **1本の断面** に絞り、**距離 vs 高さ** のグラフにすると、護岸の変形や沈下を数値（mm）で追いやすくなる。
- **初期（最初の計測）との差分** を取ることで、「いつ・どこが・どれだけ動いたか」が一目で分かる。

### 入口

- 実行とパラメータ変更は **Jupyter Notebook だけ** から行う（コマンドライン用のプログラムは用意していない）。
- 使うノートブック: **`notebooks/LiDAR_visualize.ipynb`**

---

## 2. データとフォルダの構成

### データの置き場所

| パス | 内容 |
|------|------|
| `data/LiDAR/<case>/` | PLY 点群ファイル（例: `4s80.ply`, `4s82.ply`, …）。`<case>` は例: `No4-friction-8mm`, `No7-friction-8mm` |
| `params/<case>.yaml` | 断面を決める2点と護岸の1点（後述）を書いた設定ファイル。フォルダ名と同じ `<case>` で対応させる |

### パラメータファイル（YAML）の意味

`params/<case>.yaml` には、次の3つの点を **メートル単位の [x, y, z]** で書きます。

| 名前 | 意味 |
|------|------|
| **point1** | 断面直線の「片方の端」の点（例: 水槽側の点） |
| **point2** | 断面直線の「もう一方の端」の点（例: 土層側の点） |
| **revetment** | 護岸の内側を表す点。Zoom グラフの「0 mm」の基準や凡例の基準に使う |

例（`params/No4-friction-8mm.yaml`）:

```yaml
points:
  point1: [-0.036713, 0.373845, -1.278917]   # 水槽の点
  point2: [-0.029054, -0.255728, -0.746375]  # 土層の点
  revetment: [0.011898, 0.086200, -0.854366] # 護岸内側の点
```

**断面** は、この **point1 と point2 を結んだ直線** を「切る面」として使います。

---

## 3. 処理の流れ（全体のステップ）

大まかな流れは次のとおりです。

```
[1] PLY を読み込む
       ↓
[2] 地面の向きを推定して「鉛直」を揃える（傾き補正）
       ↓
[3] point1–point2 直線に沿った「断面」の点だけを抽出
       ↓
[4] 断面の「距離 vs 高さ(Z)」のプロファイルを作る
       ↓
[5] プロファイルを前処理（等間隔化・スパイク除去・平滑化）
       ↓
[6] 全ファイルを「共通の距離グリッド」に揃える
       ↓
[7] 最初の断面を基準に「差分」を計算
       ↓
[8] グラフで可視化（断面の形・差分・Zoom 区間など）
```

- 各 PLY ファイル（各時刻）に対して [1]～[6] をやり、最後に [7][8] でまとめて描画します。
- 以下、各ステップで「何をしているか」と「主なパラメータの意味」を説明します。

---

## 4. 各処理の内容とパラメータの意味

### 4.1 PLY の読み込み

- **やっていること**: 1つの `.ply` ファイルから、点の座標 (x, y, z) の配列を読み出す。
- **実装**: Open3D は使わず、Python 標準ライブラリと NumPy で PLY をパースしている。
- **ノートブックで変えるもの**: 対象フォルダは先頭セルの `ply_directory` で指定（例: `_project_root / "data" / "No7-friction-8mm"`）。

---

### 4.2 鉛直（傾き）補正 — 地面の向きを揃える

- **やっていること**:  
  - 点群の中から「地面」らしい平面を **RANSAC** で推定する。  
  - その平面の法線が「上」を向くように座標を回転し、**Z 軸が鉛直（重力方向）** になるようにする。
- **なぜ必要か**: LiDAR が少し傾いて計測していると、そのままでは「高さ」が斜め方向になってしまう。地面で鉛直を揃えることで、後の「高さ (Z)」を mm で解釈しやすくする。

**主なパラメータ（ノートブック先頭セル）:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `ground_z_range` | 地面候補を探す Z の範囲 (m)。`None` なら全点を使用 | `(-1.6, -1.4)` または `None` |
| `ground_xy_range` | 地面候補を探す XY の範囲。`None` なら制限なし | `None` または `((xmin,xmax),(ymin,ymax))` |
| `ground_distance_threshold` | RANSAC で「平面に乗っている」とみなす距離の閾値 (m) | `0.001` |
| `ground_ransac_n` | RANSAC の1回の試行で使う点の数 | `3` |
| `ground_num_iterations` | RANSAC の試行回数 | `1000` |

---

### 4.3 断面の抽出

- **やっていること**:  
  - **point1 と point2 を結ぶ直線** を含み、かつ「新しい Z 軸（鉛直）に平行な平面」から、一定距離以内の点だけを抜き出す。  
  - つまり「その直線のまわりに薄くスライスした断面」の点群を得る。
- **条件**:
  - その平面からの距離が `cross_section_threshold` 以内
  - 直線上の位置が point1 ～ point2 の間（射影で判定）
  - （オプション）補正後の Z が `cross_section_z_range` の範囲内（床などを除く）

**主なパラメータ:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `cross_section_threshold` | 断面とみなす「平面からの距離」の閾値 (m) | `0.005` |
| `cross_section_z_range` | 補正後 Z の範囲 (m)。`None` なら範囲制限なし | `(-1.05, -0.75)` または `None` |

※ point1 / point2 / revetment は `params/<case>.yaml` で指定。

---

### 4.4 断面プロファイルの作成

- **やっていること**:  
  - 抽出した断面点について、**point1 からの距離（断面に沿った距離）** を x、**補正後の Z（高さ）** を y とする。  
  - 単位は **mm**（Z は m→mm で 1000 倍）。  
  - さらに、使う範囲を `start_index` ～ `end_index_max` でクリップする。
- **結果**: 「距離 [mm] vs 高さ [mm]」の1本のプロファイル（2つの配列 `x`, `z`）。

**主なパラメータ:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `start_index` | プロファイルの先頭から使う点の開始インデックス | `0` |
| `end_index_max` | 使う点の終了インデックスの上限 | `5000` |

---

### 4.5 前処理（等間隔化・スパイク除去・平滑化）

- **やっていること**:  
  1. **等間隔化**: 距離がバラバラなら、一定間隔のグリッドに補間して並べ替える。  
  2. **スパイク除去**: メディアンフィルタで、LiDAR 特有のとげ状の外れ値を抑える。  
  3. **平滑化**: Savitzky–Golay フィルタで、ギザギザを滑らかにする（曲線の形はなるべく保つ）。
- **目的**: その後の「共通グリッドへの再サンプリング」や「差分」を、ノイズに強く・見やすい形にする。

**主なパラメータ:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `filter_dx` | 等間隔化の目標間隔 (mm)。`None` ならデータの間隔の中央値を使用 | `None` |
| `filter_uneven_tol` | 「不等間隔」とみなすしきい値（CV や range_ratio と比較） | `0.01` |
| `filter_median_k` | メディアンフィルタの窓の大きさ（点の数、奇数に丸められる） | `5` |
| `filter_sg_window` | Savitzky–Golay の窓長（点の数、奇数に調整） | `21` |
| `filter_sg_poly` | Savitzky–Golay の多項式の次数 | `3` |
| `filter_interp_method` | 補間の方法 | `"linear"` |

---

### 4.6 共通グリッドへの再サンプリング

- **やっていること**:  
  - すべての時刻（すべての PLY）のプロファイルを、**同じ「距離の目盛り」**（共通グリッド）の上に補間して並べる。  
  - 例: 「0 mm ～ 165 mm を 500 点に分割」した `common_x` の各位置での高さを、各ファイルから計算する。
- **なぜ必要か**: 時刻ごとに点の並びが違うと差分が取りにくいので、「同じ距離」どうしで引き算できるようにする。

**主なパラメータ:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `common_x_min` | 共通グリッドの最小距離 (mm) | `0.0` |
| `common_x_max` | 共通グリッドの最大距離 (mm)。`None` なら point1–point2 の長さから自動計算 | `None` |
| `common_x_points` | 共通グリッドの点の数 | `500` |

---

### 4.7 初期断面との差分

- **やっていること**:  
  - **最初に処理した PLY（idx=0）** のプロファイルを「基準」とする。  
  - 他の時刻のプロファイルから、この基準を引いて **差分 [mm]** を計算する。  
  - 基準自身の差分は 0 になる。
- **意味**: 「その距離の位置で、初期から何 mm 沈んだか／上がったか」が、共通グリッド上の一列の数値で得られる。

---

### 4.8 可視化

- **やっていること**:  
  - **初期断面**: 点群と断面直線・鉛直方向を、元座標系と補正後の座標系の両方で表示。  
  - **断面グラフ**:  
    - 等間隔化前・フィルタ前・処理後の計測値・差分 などを、別々の図で表示。  
    - 必要に応じて「Zoom」で、護岸付近など特定区間だけを拡大表示する。  
  - Zoom の 0 mm 基準は、護岸点（revetment）を断面直線に射影した位置＋`revetment_shift_mm` で調整できる。

**主なパラメータ:**

| パラメータ | 意味 | 例 |
|------------|------|-----|
| `ply_directory` | 使う PLY が入ったフォルダ | `_project_root / "data" / "No7-friction-8mm"` |
| `revetment_shift_mm` | Zoom グラフの 0 点を左右にずらす量 (mm) | `0` |
| `plot_legend_names` | 凡例に出す名前のリスト。`None` ならファイル名を使用 | `["Initial", "5 minutes", …]` |
| `plot_zoom_width` | Zoom 区間の幅 (mm)。護岸交点からこの幅だけ表示 | `220` |
| `plot_show_zoom` | Zoom グラフも出すか | `True` |
| `plot_ylim_difference_zoom` | Zoom の差分グラフの Y 軸範囲 | `(-100, 10)` など |
| `plot_ylim_displacement_zoom` | Zoom の計測値グラフの Y 軸範囲 | `(-860, -750)` など |

---

## 5. ノートブックのセル構成（実行順）

1. **先頭セル**: パラメータ設定（`ply_directory`, YAML から point1/point2/revetment 読み込み、上で説明した各種パラメータ）
2. **インポート**: `src.lidar` から必要な関数をインポート
3. **安全チェック**: 共通グリッド・前処理・インデックスの値が妥当かチェック
4. **PLY 一覧取得**: 対象フォルダ内の `.ply` を取得し、自然順でソート（必要なら `plot_legend_names` に合わせてファイルを選ぶ）
5. **共通グリッド定義**: `common_x_min` ～ `common_x_max` を `common_x_points` 点に分割（`common_x_max` が `None` のときは断面長から自動設定）
6. **各 PLY の処理**: 読み込み → 地面推定・回転 → 断面抽出 → プロファイル作成 → 前処理 → 共通グリッドへ再サンプリング → 差分計算、をループ
7. **初期断面の図**: 点群と断面・鉛直方向の可視化
8. **断面・差分の図**: 計測値・差分・Zoom などのグラフを表示

上から順に実行すれば、最後までエラーにならずに図まで出る想定です。

---

## 6. 環境の準備と実行方法

### 必要なもの

- Python 3.12
- 依存ライブラリ: NumPy, SciPy, Matplotlib, PyYAML, Jupyter（Notebook）, PyQt6（別ウィンドウで図を表示する場合）など

### セットアップ（例: uv を使う場合）

```bash
# プロジェクトのルートで
uv sync
```

これで `pyproject.toml` に書いた依存関係が入ります。

### 実行

1. Jupyter を起動し、**`notebooks/LiDAR_visualize.ipynb`** を開く。
2. カーネルは、このプロジェクトの仮想環境（`uv sync` で作った環境）を選ぶ。
3. 上から順にセルを実行する。
4. 先頭セルの `ply_directory` を変えれば、別の `<case>`（別フォルダ）のデータを同じ手順で解析できる。その場合は `params/<case>.yaml` を同じ `<case>` 名で用意する。

---

## 7. ソースコードの役割（参考）

| モジュール | 主な役割 |
|------------|----------|
| `src/lidar/io_ply.py` | PLY の読み込み、ファイル名の自然順ソート |
| `src/lidar/leveling.py` | 地面平面の RANSAC 推定、回転行列の作成・適用 |
| `src/lidar/geometry.py` | 直線との距離・射影、断面抽出（平面からの距離でスライス） |
| `src/lidar/profile.py` | 断面点から「距離–高さ」プロファイルの作成、インデックスでのクリップ |
| `src/lidar/preprocess_lidar.py` | 等間隔化・メディアンフィルタ・Savitzky–Golay 平滑化 |
| `src/lidar/resample.py` | 共通グリッドへの再サンプリング |
| `src/lidar/plotting.py` | 初期断面の図、断面・差分・Zoom のグラフ描画 |

点群の読み込み・地面推定・幾何計算は **Open3D を使わず**、NumPy・SciPy・標準ライブラリだけで実装しています。

---

## 8. まとめ

- **目的**: LiDAR 点群から護岸の「1本の垂直断面」の形状を取り出し、**初期との差分 [mm]** を時間経過で見る。
- **パラメータ**: データフォルダ・YAML の3点（point1, point2, revetment）のほか、地面推定・断面抽出・前処理・共通グリッド・描画の各段階で、上記のパラメータで挙動を変えられる。
- **処理の流れ**: PLY 読み込み → 鉛直補正 → 断面抽出 → プロファイル作成 → 前処理 → 共通グリッドに揃える → 差分計算 → 可視化。
- **入口**: `notebooks/LiDAR_visualize.ipynb` を上から実行するだけで、目的のグラフまで一通り得られる。

パラメータの意味や処理の順序で迷ったときは、この README の「4. 各処理の内容とパラメータの意味」と「5. ノートブックのセル構成」を参照すると整理しやすいです。
